var dataListWatcher=new Class({Implements:[Options],dataListStorage:{},options:{selector:'.datalist',currentView:null,autoShow:!1},initialize:function(options){this.setOptions(options);if(this.options.autoShow){jQuery(window).on('mutate',this.autoShow.bind(this))}},autoShow:function(){jQuery(this.options.currentView).find(this.options.selector).each(function(n,element){if(jQuery(element).length>0&&((typeof this.dataListStorage[jQuery(element).attr('id')])=='undefined')){this.dataListStorage[jQuery(element).attr('id')]=new dataList(element,this.options)}}.bind(this))},});var _dataList=new Class({Implements:[Options],elementData:null,initialize:function(element,options){this.setOptions(options);this.element=$(element);this.elementData=$(element).data();this.build();this.attachEvents()},onRemove:function(e){e.preventDefault();target=$(e.target);parent=target.parents('.connitem');itemid=parent.attr('dhx_f_id');this.dataView.remove(itemid)},attachEvents:function(){this.element.on('click','a.remove',[],this.onRemove.bind(this))},refresh:function(){setTimeout(function(){this.dataView.refresh()}.bind(this),100)},add:function(element){this.dataView.add(element)},build:function(){height=this.options.height?this.options.height:'auto';this.dataView=new dhtmlXDataView({"container":this.element.attr('id'),auto_scroll:!0,height:300,edit:!0,drag:!0,type:{template_edit:"<textarea class='dhx_item_editor' bind='obj.Package'>"}});var elid=this.element.attr('id');this.dataView.template_item_start=dhtmlx.Template.fromHTML("<div class='list-group-item connitem' data-itemid='{-obj.id}' dhx_f_id='{-obj.id}'  style='overflow:hidden;'>");this.dataView.template_item_end=dhtmlx.Template.fromHTML("</div>");this.dataView.define('type','fdatalistitem');this.dataView.customize({icons_src_dir:'/x4/adm/xjs/_components/dhtmlx/dataview/codebase/imgs',});this.dataView.clearAll();this.dataView.refresh()}});var xListServer=new Class({Implements:[Options],options:{template:'<li><a href="{href}"  id="{id}" class="button">{name}</a></li>',callerButtonSelector:'.xList',height:500,width:700,text:'New window'},window:null,callbacks:[],jQuery:'xlist',initialize:function(options){this.setOptions(options);this.container=jQuery(this.options.callerButtonSelector);$(document).on('click',this.options.callerButtonSelector,this.callButtonHandler.bind(this))},pushCallBack:function(index,callFunc){this.callbacks[index]=callFunc},returnData:function(data){$('#'+this.returnElement).val(data.name);$('#'+this.returnElement+'Id').val(data.id);$('#'+this.returnElement).trigger("change");$('#'+this.returnElement+'Id').trigger("change");if(this.onDataReturn){this.callBacks(this.onDataReturn,data)}
that=this;setTimeout(function(){that.window.close()},100)},callBacks:function(callback,data){callback=callback.split('.');if(callback.length>1){if(module=AI.loadModule(callback[0],'silent',!0)){if(typeof module[callback[1]]=='function'){module[callback[1]](this,data)}}}else{if(typeof this.callbacks[callback[0]]=='function'){this.callbacks[callback[0]](this,data)}}},callButtonHandler:function(e){if(!$(e.target).is('a'))return;e.preventDefault();if(!(width=$(e.target).data('winwidth'))){width=this.options.width}
if(!(height=$(e.target).data('winheight'))){height=this.options.height}
this.window=AI.dhxWins.createWindow("xlistWindow",20,10,width,height,1);if(!(txt=$(e.target).data('wintext'))){txt=this.options.text}
this.window.button('park').hide();this.info=$(e.target).data('info');this.currentElement=e.target;this.window.attachEvent("onHide",function(win){win.close()});this.window.setText(txt);this.window.centerOnScreen();if(!(this.returnElement=$(e.target).data('destination'))){debug.log('xlist:return element not found for - ');debug.log(e.target)}
if(val=$(e.target).data('topindex')){this.window.bringToTop(val)}
if(onDataReturn=$(e.target).data('onDataReturn')){this.onDataReturn=onDataReturn}
if(callback=$(e.target).data('callback')){this.callBacks(callback)}}});var FileMan=new Class({Implements:[Options,Events],copyBuffer:null,copyPath:null,options:{prefixPath:'/media/',speed:1000,currentPath:['']},initialize:function(selector,options){this.setOptions(options);jQuery(selector).click(this.open.bind(this));this.fileman=AI.dhxWins.createWindow('fileman',20,10,930,700,1);this.fileman.setText(AI.translate('common','file-manager'));this.container=$(this.fileman.dhxContGlobal.dhxcont.mainCont);this.container.css({'overflow-y':'hidden'});this.fileman.bringToTop(99);this.fileman.attachHTMLString(TH.getTpl('AdminPanel','fileManager'));this.fileman.button('minmax1').hide();this.fileman.attachEvent("onHide",this.onHide.bind(this));this.folderSelect=!1;this.currentClickItemHandler=this.defaultClickItemHandler.bind(this);this.container.find('a.back').click(this.back.bind(this));this.container.find('.viewSelect li a').click(this.viewSelect.bind(this));this.container.find('a.createFolder').click(this.createFolder.bind(this));this.container.find('a.selectFolder').click(this.selectFolder.bind(this));this.filesBody=this.container.find('#files');this.connector=new Connector('matrixFileManager','.class');this.imageshow=jQuery('#imageshow');jQuery(this.imageshow).hide();this.menu=new dhtmlXMenuObject();this.menu.renderAsContextMenu();this.menu.addNewChild(this.menu.topId,0,'refresh',AI.translate('common','refresh'),!1,'','',this.renderFiles.bind(this));this.menu.addNewChild(this.menu.topId,0,'select',AI.translate('common','select_all'),!1,'','',this.selectAll.bind(this));this.menu.addNewChild(this.menu.topId,0,'copy',AI.translate('common','copy'),!1,'','',this.copy.bind(this));this.menu.addNewChild(this.menu.topId,0,'paste',AI.translate('common','paste'),!1,'','',this.paste.bind(this));this.menu.addNewChild(this.menu.topId,0,'delete',AI.translate('common','delete'),!1,'','',this.deleteAll.bind(this));this.menu.addNewChild(this.menu.topId,0,'download',AI.translate('common','download'),!1,'','',this.download.bind(this));this.menu.addNewChild(this.menu.topId,0,'IPTC_data',AI.translate('common','IPTC_data'),!1,'','',this.IPTCdata.bind(this));this.menu.attachEvent("onShow",function(id){menuLink=this});this.data=new dhtmlXDataView('files');this.data.define('type','ficon');this.data.attachEvent('onItemDblClick',this.onItemDblClick.bind(this));this.data.attachEvent('onBeforeContextMenu',this.onBeforeContextMenus.bind(this));this.data.customize({icons_src_dir:'/x4/adm/xjs/_components/dhtmlx/dataview/codebase/imgs'});this.fileman.attachEvent('onResizeFinish',function(win){this.data.refresh()}.bind(this));this.fileman.hide();jQuery(document).on('click','.fileManagerApplyButton',this.applyButtonClick.bind(this));jQuery(document).on('click','.fileManagerClearInput',this.clearButtonClick.bind(this));jQuery(document).on('click','#fm .iptccancel',this.cancelIPTCWin.bind(this));jQuery(document).on('click','#fm .iptcsave',this.IPTCdataSet.bind(this));this.dropzone=new Dropzone(this.container.find('div#dropzone')[0],{url:'/admin.php?action=getfile',dictDefaultMessage:AI.translate('matrix','drop_files_here_to_upload'),dictFallbackMessage:AI.translate('matrix','browser_not_support_drag_upload'),dictFallbackText:AI.translate('matrix','use_form_to_upload'),dictFileTooBig:AI.translate('matrix','file_is_too_big'),dictInvalidFileType:AI.translate('matrix','cant_upload_this_file_type'),dictResponseError:AI.translate('matrix','server_respond_with_code'),dictCancelUpload:AI.translate('matrix','cancel_upload'),dictCancelUploadConfirmation:AI.translate('matrix','shure_to_cancel'),dictRemoveFile:AI.translate('matrix','remove_file'),dictRemoveFileConfirmation:null,dictMaxFilesExceeded:AI.translate('matrix','max_files_exceed')});this.dropzone.on('complete',function(file){this.dropzone.removeFile(file);setTimeout(this.renderFiles.bind(this),100)}.bind(this));jQuery('#files').bind('contextmenu',this.context.bind(this))},cancelIPTCWin:function(e){e.preventDefault();$('#iptcwin').hide()},IPTCdataSet:function(e){e.preventDefault();data=xoad.html.exportForm('iptcForm');data.filename=this.iptcFile;this.connector.execute({setIPTC:data});$('#iptcwin').hide()},IPTCdata:function(id){items=this.getSelectedItems();if(items){filename=this.parsePath(this.options.currentPath)+items[0];this.connector.execute({getIPTC:{filename:filename}});if(this.connector.result.iptc.enabled){xoad.html.importForm('iptcForm',this.connector.result.iptc);this.iptcFile=filename;$('#iptcwin').show()}}},download:function(e){if(name=this.getSelectedItems()){this.connector.execute({pushFileToDownload:{name:this.parsePath(this.options.currentPath)+name}});if(this.connector.result.pushed){$.fileDownload('/admin.php?action=download')}}},onHide:function(e){AI.dhxWins.forEachWindow(function(win){win.bringToTop(99)})},viewSelect:function(e){e.preventDefault();this.data.define('type',$(e.target).data('view'));this.data.customize({icons_src_dir:'/x4/adm/xjs/_components/dhtmlx/dataview/codebase/imgs'})},setPrefixPath:function(prefix){this.options.prefixPath=prefix},clearButtonClick:function(event){event.preventDefault();target=$(event.target);$(target.parents('.input-group')[0]).find('input').val('')},dirname:function(path){return path.replace(/\\/g,'/').replace(/\/[^\/]*\/?$/,'')},applyButtonClick:function(event){event.preventDefault();this.targetElement=$(event.target);if(!this.targetElement.hasClass('fileManagerApplyButton')||this.targetElement.hasClass('fa')){this.targetElement=this.targetElement.parent()}
this.applyButtonOptions=$(this.targetElement).data();this.currentClickItemHandler=this.returnPathClickHandler.bind(this);input=$(this.targetElement).closest('.input-group').find('input');currentPath=input.val();if(currentPath){currentPath=currentPath.replace('//',"/");currentPath=currentPath.replace(this.options.prefixPath,"");currentPath=this.dirname(currentPath);currentPath=currentPath.split('/').reverse();this.options.currentPath=currentPath}
if(this.applyButtonOptions&&this.applyButtonOptions.target){switch(this.applyButtonOptions.target){case 'folder':{this.currentClickItemHandler=this.returnFolderClickHandler.bind(this)}}}
this.open()},defaultClickItemHandler:function(id,ev){alert(this.data.get(id).name)},enableUpperPanel:function(state){if(state){this.container.find('.panel').show()}else{this.container.find('.panel').hide()}},enableBottomPanel:function(state){if(state){this.container.find('.panel').show()}else{this.container.find('.panel').hide()}},enableDropZone:function(state){if(state){$(this.dropzone.element).show()}else{$(this.dropzone.element).hide()}},returnFolderClickHandler:function(){},getPathForCurrentElement:function(id){path=this.options.prefixPath+this.parsePath(this.options.currentPath)+this.data.get(id).name;return path.replace('//',"/")},returnPathClickHandler:function(id,ev){this.fileman.hide();itemPath=this.getPathForCurrentElement(id);$(this.targetElement.parents('.input-group')[0]).find('input').val(itemPath);this.targetElement.data('itemPath',itemPath)},selectFolder:function(es){this.fileman.hide();itemPath=this.options.prefixPath+this.parsePath(this.options.currentPath);$(this.targetElement.parents('.input-group')[0]).find('input').val(itemPath);this.targetElement.data('itemPath',itemPath)},getSelectedItems:function(){if(selected=this.data.getSelected(!0)){names=[];for(i=0;i<selected.length;i++){itemName=this.data.get(selected[i]).name;names.push(itemName)}
return names}else{return!1}},onBeforeContextMenus:function(id,e){this.menu._doOnContextBeforeCall(e,{id:id});id=this.data.getSelected();return!1},context:function(e){e.preventDefault();this.menu.showContextMenu(e.pageX,e.pageY);return!1},selectAll:function(zid,id){this.data.select()},copy:function(){if(names=this.getSelectedItems()){this.copyBuffer=names;this.copyPath=this.options.currentPath}},paste:function(){if(this.copyBuffer.length>0){this.connector.execute({copyFiles:{names:this.copyBuffer,path:this.parsePath(this.copyPath),currentPath:this.parsePath(this.options.currentPath)}});if(this.connector.result.copy){this.renderFiles()}}},deleteAll:function(){if((names=this.getSelectedItems())&&(confirm(AI.translate('common','you_really_wish_to_remove_this_objects')))){this.connector.execute({unlinkFiles:{names:names,currentPath:this.parsePath(this.options.currentPath)}});if(this.connector.result.unlink){this.renderFiles()}}},back:function(){this.options.currentPath.shift();this.renderFiles()},onItemDblClick:function(id,ev,html){if(this.data.get(id).type=='dir'){this.options.currentPath.unshift(this.data.get(id).name);this.renderFiles()}else{this.currentClickItemHandler(id,ev)}},createFolder:function(){var reply=prompt(AI.translate('matrix','enter_folder_name'));reply=reply.trim();if(reply.length>0){this.connector.execute({createFolder:{name:reply}});if(this.connector.result.folderCreated){this.renderFiles()}}},setPath:function(path){if(path){path=this.extractPath(path);pathArray=path.path.split('/');if(this.options.prefixPath)delete pathArray[1];this.options.currentPath=pathArray.reverse()}},detectTarget:function(){this.container.find('.folder-submit').hide();this.folderSelect=!1;if(this.applyButtonOptions&&this.applyButtonOptions.target){switch(this.applyButtonOptions.target){case 'folder':{this.container.find('.folder-submit').show(200);this.folderSelect=!0}}}},openSmall:function(path){this.enableDropZone(!1);this.container.find('.hideme').hide();this.fileman.bringToTop(35);this.fileman.show();this.detectTarget();this.fileman.centerOnScreen();this.setPath(this.targetElement.data('itemPath'));this.fileman.setDimension('640','600');this.renderFiles();this.filesBody.css({height:380})},open:function(zindex){if(!zindex)zindex=99;this.fileman.bringToTop(zindex);this.renderFiles();this.filesBody.css({height:390});this.detectTarget();this.fileman.show();this.fileman.centerOnScreen();this.fileman.setDimension('980','600')},renderFiles:function(){this.data.clearAll();currentPath=this.parsePath(this.options.currentPath);this.connector.execute({'getWalk':{'path':currentPath,'mode':'icons','filter':'*'}});this.container.find('input[name="currentPath"]').val(currentPath);this.dropzone.options.params={'path':currentPath};if(typeof this.connector.result.error=='undefined'){for(var i in this.connector.result.filesMatrix){if(typeof this.connector.result.filesMatrix[i].ext!=='undefined')
this.data.add({name:this.connector.result.filesMatrix[i].nam,mod:this.connector.result.filesMatrix[i].mod,type:this.connector.result.filesMatrix[i].ext,fullpath:'/media'+currentPath+this.connector.result.filesMatrix[i].nam,size:this.connector.result.filesMatrix[i].size})}
this.data.refresh()}},extractPath:function(data){var m=data.match(/(.*)[\/\\]([^\/\\]+)$/);if(m)return{path:m[1],last:m[2]}},parsePath:function(arr){var path='';if(arr){for(var index=arr.length-1;index>=0;index--){path=path+arr[index]+'/'}}
return path}});(function($,window){var htmlSpecialCharsRegEx=/[<>&\r\n"']/gm;var htmlSpecialCharsPlaceHolders={'<':'lt;','>':'gt;','&':'amp;','\r':"#13;",'\n':"#10;",'"':'quot;',"'":'#39;'};$.extend({fileDownload:function(fileUrl,options){var settings=$.extend({preparingMessageHtml:null,failMessageHtml:null,androidPostUnsupportedMessageHtml:"Unfortunately your Android browser doesn't support this type of file download. Please try again with a different browser.",dialogOptions:{modal:!0},prepareCallback:function(url){},successCallback:function(url){},failCallback:function(responseHtml,url,error){},httpMethod:"GET",data:null,checkInterval:100,cookieName:"fileDownload",cookieValue:"true",cookiePath:"/",cookieDomain:null,popupWindowTitle:"Initiating file download...",encodeHTMLEntities:!0},options);var deferred=new $.Deferred();var userAgent=(navigator.userAgent||navigator.vendor||window.opera).toLowerCase();var isIos;var isAndroid;var isOtherMobileBrowser;if(/ip(ad|hone|od)/.test(userAgent)){isIos=!0}else if(userAgent.indexOf('android')!==-1){isAndroid=!0}else{isOtherMobileBrowser=/avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|playbook|silk|iemobile|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test(userAgent.substr(0,4))}
var httpMethodUpper=settings.httpMethod.toUpperCase();if(isAndroid&&httpMethodUpper!=="GET"&&settings.androidPostUnsupportedMessageHtml){if($().dialog){$("<div>").html(settings.androidPostUnsupportedMessageHtml).dialog(settings.dialogOptions)}else{alert(settings.androidPostUnsupportedMessageHtml)}
return deferred.reject()}
var $preparingDialog=null;var internalCallbacks={onPrepare:function(url){if(settings.preparingMessageHtml){$preparingDialog=$("<div>").html(settings.preparingMessageHtml).dialog(settings.dialogOptions)}else if(settings.prepareCallback){settings.prepareCallback(url)}},onSuccess:function(url){if($preparingDialog){$preparingDialog.dialog('close')}
settings.successCallback(url);deferred.resolve(url)},onFail:function(responseHtml,url,error){if($preparingDialog){$preparingDialog.dialog('close')}
if(settings.failMessageHtml){$("<div>").html(settings.failMessageHtml).dialog(settings.dialogOptions)}
settings.failCallback(responseHtml,url,error);deferred.reject(responseHtml,url)}};internalCallbacks.onPrepare(fileUrl);if(settings.data!==null&&typeof settings.data!=="string"){settings.data=$.param(settings.data)}
var $iframe,downloadWindow,formDoc,$form;if(httpMethodUpper==="GET"){if(settings.data!==null){var qsStart=fileUrl.indexOf('?');if(qsStart!==-1){if(fileUrl.substring(fileUrl.length-1)!=="&"){fileUrl=fileUrl+"&"}}else{fileUrl=fileUrl+"?"}
fileUrl=fileUrl+settings.data}
if(isIos||isAndroid){downloadWindow=window.open(fileUrl);downloadWindow.document.title=settings.popupWindowTitle;window.focus()}else if(isOtherMobileBrowser){window.location(fileUrl)}else{$iframe=$("<iframe>").hide().prop("src",fileUrl).appendTo("body")}}else{var formInnerHtml="";if(settings.data!==null){$.each(settings.data.replace(/\+/g,' ').split("&"),function(){var kvp=this.split("=");var k=kvp[0];kvp.shift();var v=kvp.join("=");kvp=[k,v];var key=settings.encodeHTMLEntities?htmlSpecialCharsEntityEncode(decodeURIComponent(kvp[0])):decodeURIComponent(kvp[0]);if(key){var value=settings.encodeHTMLEntities?htmlSpecialCharsEntityEncode(decodeURIComponent(kvp[1])):decodeURIComponent(kvp[1]);formInnerHtml+='<input type="hidden" name="'+key+'" value="'+value+'" />'}})}
if(isOtherMobileBrowser){$form=$("<form>").appendTo("body");$form.hide().prop('method',settings.httpMethod).prop('action',fileUrl).html(formInnerHtml)}else{if(isIos){downloadWindow=window.open("about:blank");downloadWindow.document.title=settings.popupWindowTitle;formDoc=downloadWindow.document;window.focus()}else{$iframe=$("<iframe style='display: none' src='about:blank'></iframe>").appendTo("body");formDoc=getiframeDocument($iframe)}
formDoc.write("<html><head></head><body><form method='"+settings.httpMethod+"' action='"+fileUrl+"'>"+formInnerHtml+"</form>"+settings.popupWindowTitle+"</body></html>");$form=$(formDoc).find('form')}
$form.submit()}
setTimeout(checkFileDownloadComplete,settings.checkInterval);function checkFileDownloadComplete(){var cookieValue=settings.cookieValue;if(typeof cookieValue=='string'){cookieValue=cookieValue.toLowerCase()}
var lowerCaseCookie=settings.cookieName.toLowerCase()+"="+cookieValue;if(document.cookie.toLowerCase().indexOf(lowerCaseCookie)>-1){internalCallbacks.onSuccess(fileUrl);var cookieData=settings.cookieName+"=; path="+settings.cookiePath+"; expires="+new Date(0).toUTCString()+";";if(settings.cookieDomain)cookieData+=" domain="+settings.cookieDomain+";";document.cookie=cookieData;cleanUp(!1);return}
if(downloadWindow||$iframe){try{var formDoc=downloadWindow?downloadWindow.document:getiframeDocument($iframe);if(formDoc&&formDoc.body!==null&&formDoc.body.innerHTML.length){var isFailure=!0;if($form&&$form.length){var $contents=$(formDoc.body).contents().first();try{if($contents.length&&$contents[0]===$form[0]){isFailure=!1}}catch(e){if(e&&e.number==-2146828218){isFailure=!0}else{throw e}}}
if(isFailure){setTimeout(function(){internalCallbacks.onFail(formDoc.body.innerHTML,fileUrl);cleanUp(!0)},100);return}}}catch(err){internalCallbacks.onFail('',fileUrl,err);cleanUp(!0);return}}
setTimeout(checkFileDownloadComplete,settings.checkInterval)}
function getiframeDocument($iframe){var iframeDoc=$iframe[0].contentWindow||$iframe[0].contentDocument;if(iframeDoc.document){iframeDoc=iframeDoc.document}
return iframeDoc}
function cleanUp(isFailure){setTimeout(function(){if(downloadWindow){if(isAndroid){downloadWindow.close()}
if(isIos){if(downloadWindow.focus){downloadWindow.focus();if(isFailure){downloadWindow.close()}}}}},0)}
function htmlSpecialCharsEntityEncode(str){return str.replace(htmlSpecialCharsRegEx,function(match){return'&'+htmlSpecialCharsPlaceHolders[match]})}
var promise=deferred.promise();promise.abort=function(){cleanUp();$iframe.remove()};return promise}})})(jQuery,this);(function($){var methods={init:function(options){var defaults={colHeaders:[],colWidths:[],colAlignments:[],columns:[],minSpareRows:0,minSpareCols:0,minDimensions:[0,0],contextMenu:null,columnSorting:!0,columnResize:!0,rowDrag:!0,editable:!0,allowInsertRow:!0,allowInsertColumn:!1,allowDeleteRow:!0,allowDeleteColumn:!0,wordWrap:!1,about:'jExcel Spreadsheet\\nVersion 1.3.3\\nAuthor: Paul Hodel <paul.hodel@gmail.com>\\nWebsite: http://bossanova.uk/jexcel'};var options=$.extend(defaults,options);if(options.manualColumnResize!=undefined){options.columnResize=options.manualColumnResize}
if(options.manualRowMove!=undefined){options.rowDrag=options.manualRowMove}
var id=$(this).prop('id');var main=$(this);prepareTable=function(){if(!$.fn.jexcel.defaults){$.fn.jexcel.defaults=new Array()}
$.fn.jexcel.defaults[id]=options;$.fn.jexcel.defaults[id].history=[];$.fn.jexcel.defaults[id].historyIndex=-1;var results=[];if(!options.data){options.data=[]}
if(!$.fn.jexcel.defaults[id].data.length){$.fn.jexcel.defaults[id].data=[[]]}
size=options.colHeaders.length;if(options.data[0].length>size){size=options.data[0].length}
if($.fn.jexcel.defaults[id].minDimensions[0]>size){size=$.fn.jexcel.defaults[id].minDimensions[0]}
for(i=0;i<size;i++){if(!options.colHeaders[i]){options.colHeaders[i]=$.fn.jexcel('getColumnName',i)}
if(!options.columns[i]){options.columns[i]={type:'text'}}else if(!options.columns[i]){options.columns[i].type='text'}
if(!options.columns[i].source){$.fn.jexcel.defaults[id].columns[i].source=[]}
if(!options.columns[i].options){$.fn.jexcel.defaults[id].columns[i].options=[]}
if(!options.columns[i].editor){options.columns[i].editor=null}
if(!options.colAlignments[i]){options.colAlignments[i]='center'}
if(!options.colWidths[i]){options.colWidths[i]='50'}
if(options.columns[i].type=='autocomplete'||options.columns[i].type=='dropdown'){if(options.columns[i].url){results.push($.ajax({url:options.columns[i].url,index:i,dataType:'json',success:function(result){$.fn.jexcel.defaults[id].columns[this.index].source=result},error:function(result){console.error('It was not possible to load the url: '+this.url)}}))}}else if(options.columns[i].type=='calendar'){if(!$.fn.jexcel.defaults[id].columns[i].options.format){$.fn.jexcel.defaults[id].columns[i].options.format='DD/MM/YYYY'}}}
if(results.length>0){$.when.apply(this,results).done(function(){$(main).jexcel('createTable')})}else{$(main).jexcel('createTable')}}
if(options.csv){if(!$.csv){console.error('Jexcel error: jquery-csv library not loaded')}else{options.delimiter=options.delimiter||',';$.ajax({url:options.csv,success:function(result){var i=0;var data=$.csv.toArrays(result);if(options.csvHeaders==!0){options.colHeaders=data.shift()}
options.data=data;prepareTable()}})}}else if(options.url){$.ajax({url:options.url,dataType:'json',success:function(result){options.data=(result.data)?result.data:result;prepareTable()}})}else{prepareTable()}},createTable:function(){var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];var table=document.createElement('table');$(table).prop('class','jexcel bossanova-ui');$(table).prop('cellpadding','0');$(table).prop('cellspacing','0');$(table).prop('unselectable','yes');$(table).prop('onselectstart','return false');$(table).prop('draggable','false');var thead=document.createElement('thead');var tbody=document.createElement('tbody');$(thead).prop('class','jexcel_label');var tr='<td width="30" class="jexcel_label"></td>';for(i=0;i<options.colHeaders.length;i++){width=options.colWidths[i];align=options.colAlignments[i];header=options.colHeaders[i];if(options.columns[i].type=='hidden'){tr+='<td id="col-'+i+'" style="display:none;">'+options.colHeaders[i]+'</td>'}else{tr+='<td id="col-'+i+'" width="'+width+'" align="'+align+'">'+header+'</td>'}}
$(thead).html('<tr>'+tr+'</tr>');$(table).append(thead);$(table).append(tbody);$(table).on('dragstart',function(){return!1});$(this).html(table);if(!$('.jexcel_corner').length){var corner=document.createElement('div');$(corner).prop('class','jexcel_corner');$(corner).prop('id','corner');var textarea=document.createElement('textarea');$(textarea).prop('class','jexcel_textarea');$(textarea).prop('id','textarea');var contextMenu=document.createElement('div');$(contextMenu).css('display','none');$(contextMenu).prop('class','jexcel_contextmenu');$(contextMenu).prop('id','jexcel_contextmenu');var ads=document.createElement('div');$(ads).css('display','none');$(ads).html('<a href="http://github.com/paulhodel/jexcel">jExcel Spreadsheet</a>');$('body').append(corner);$('body').append(textarea);$('body').append(contextMenu);$('body').append(ads);$(corner).prop('unselectable','yes');$(corner).prop('onselectstart','return false');$(corner).prop('draggable','false');$(corner).on('dragstart',function(){return!1});$.fn.jexcel.selectedCorner=!1;$.fn.jexcel.selectedHeader=null;$.fn.jexcel.resizeColumn=null;$('#globalObserve').on("contextmenu",function(e){if($("#jexcel_contextmenu").css('display')=='block'){$("#jexcel_contextmenu").css('display','none')}
if($.fn.jexcel.current){var table=$(e.target).parent().parent().parent();if($(table).is('.jexcel')){var o=$(e.target).prop('id');if(o){o=o.split('-');contextMenuContent='';if(typeof(options.contextMenu)=='function'){contextMenuContent=options.contextMenu(o[0],o[1])}else{if($(e.target).parent().parent().is('thead')){contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('orderBy', "+o[1]+", 0)\">Order ascending <span></span></a>";contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('orderBy', "+o[1]+", 1)\">Order descending <span></span></a><hr>";if($.fn.jexcel.defaults[$.fn.jexcel.current].allowInsertColumn==!0){contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('insertColumn', 1, null, "+o[1]+")\">Insert a new column<span></span></a>"}
if($.fn.jexcel.defaults[$.fn.jexcel.current].allowInsertRow==!0){contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('insertRow', 1, "+o[1]+")\">Insert a new row<span></span></a><hr>"}
if($.fn.jexcel.defaults[$.fn.jexcel.current].allowDeleteColumn==!0){contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('deleteColumn',"+o[1]+")\">Delete this column<span></span></a><hr>"}
contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('download')\">Save as...<span>Ctrl + S</span></a>";if(options.about){contextMenuContent+="<a onclick=\"alert('"+options.about+"')\">About<span></span></a>"}}else if($(e.target).parent().parent().is('tbody')){if($.fn.jexcel.defaults[$.fn.jexcel.current].allowInsertColumn==!0){contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('insertColumn', 1, null, "+o[1]+")\">Insert a new column<span></span></a>"}
if($.fn.jexcel.defaults[$.fn.jexcel.current].allowInsertRow==!0){contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('insertRow', 1, "+o[1]+")\">Insert a new row<span></span></a><hr>"}
if($.fn.jexcel.defaults[$.fn.jexcel.current].allowDeleteRow==!0){contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('deleteRow',"+o[1]+")\">Delete this row<span></span></a><hr>"}
contextMenuContent+="<a onclick=\"$('#"+$.fn.jexcel.current+"').jexcel('download')\">Save as...<span>Ctrl + S</span></a>";if(options.about){contextMenuContent+="<a onclick=\"alert('"+options.about+"')\">About<span></span></a>"}}}
if(contextMenuContent){$("#jexcel_contextmenu").html(contextMenuContent);$("#jexcel_contextmenu").css({display:'block',top:e.pageY+"px",left:e.pageX+"px"});e.preventDefault()}}}}});$(document).on('mousewheel',function(e){$(".jexcel_contextmenu").css('display','none')});$(document).on('mousedown touchstart',function(e){if(e.target.id=='corner'){if($.fn.jexcel.defaults[$.fn.jexcel.current].editable==!0){$.fn.jexcel.selectedCorner=!0}}else{var table=$(e.target).parent().parent().parent();if($(table).is('.jexcel')){var current=$(table).parent().prop('id');if($.fn.jexcel.current){if($.fn.jexcel.current!=current){$('#'+$.fn.jexcel.current).jexcel('updateSelection')}}
$.fn.jexcel.current=current;if($(e.target).parent().parent().is('thead')){var o=$(e.target).prop('id');if(o){o=o.split('-');if($.fn.jexcel.selectedHeader&&(e.shiftKey||e.ctrlKey)){var d=$($.fn.jexcel.selectedHeader).prop('id').split('-')}else{var d=$(e.target).prop('id').split('-');$.fn.jexcel.selectedHeader=$(e.target)}
if($(e.target).outerWidth()-e.offsetX<8){if($.fn.jexcel.defaults[$.fn.jexcel.current].columnResize==!0){$.fn.jexcel.resizeColumn={mousePosition:e.pageX,column:o[1],width:parseInt($(e.target).css('width')),}
$(table).parent().find('.c'+o[1]).addClass('resizing');$(table).parent().find('#col-'+o[1]).addClass('resizing');$('#'+$.fn.jexcel.current).jexcel('updateSelection');$('.jexcel_corner').css('left','-200px')}}else{var o1=$('#'+$.fn.jexcel.current).find('#'+o[1]+'-0');var o2=$('#'+$.fn.jexcel.current).find('#'+d[1]+'-'+parseInt($.fn.jexcel.defaults[$.fn.jexcel.current].data.length-1));$('#'+$.fn.jexcel.current).jexcel('updateSelection',o1,o2,!1,1)}}}else{$.fn.jexcel.selectedHeader=!1}
if($(e.target).parent().parent().is('tbody')){if($(e.target).is('.jexcel_label')){if($.fn.jexcel.defaults[$.fn.jexcel.current].rowDrag==!0&&$(e.target).outerWidth()-e.offsetX<8){$('#'+$.fn.jexcel.current).jexcel('updateSelection');$(corner).css('left','-200px');$.fn.jexcel.selectedRow=null;$.fn.jexcel.selectedCell=null;$.fn.jexcel.selectedHeader=null;$.fn.jexcel.dragRowFrom=$(e.target).prop('id');$.fn.jexcel.dragRowOver=$(e.target).prop('id');$(e.target).parent().find('td').css('background-color','rgba(0,0,0,0.1)')}else{var o=$(e.target).prop('id').split('-');if($.fn.jexcel.selectedRow&&(e.shiftKey||e.ctrlKey)){var d=$($.fn.jexcel.selectedRow).prop('id').split('-')}else{var d=$(e.target).prop('id').split('-');$.fn.jexcel.selectedRow=$(e.target)}
var o1=$('#'+$.fn.jexcel.current).find('#0-'+o[1]);var o2=$('#'+$.fn.jexcel.current).find('#'+parseInt($.fn.jexcel.defaults[$.fn.jexcel.current].columns.length-1)+'-'+d[1]);$('#'+$.fn.jexcel.current).jexcel('updateSelection',o1,o2)}}else{if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if(!$.fn.jexcel.selectedCell||!e.shiftKey){$.fn.jexcel.selectedCell=$(e.target)}
$('#'+$.fn.jexcel.current).jexcel('updateSelection',$.fn.jexcel.selectedCell,$(e.target))}else{if($(e.target)!=$.fn.jexcel.selectedCell){$.fn.jexcel.selectedCell=$(e.target);$('#'+$.fn.jexcel.current).jexcel('updateSelection',$.fn.jexcel.selectedCell,$(e.target))}}
$.fn.jexcel.selectedRow=null}}}else{if(!$(e.target).parents('.jexcel').length){if($.fn.jexcel.current){$('#'+$.fn.jexcel.current).jexcel('updateSelection')}
$(corner).css('left','-200px');$.fn.jexcel.current=null;$.fn.jexcel.selectedRow=null;$.fn.jexcel.selectedCell=null;$.fn.jexcel.selectedHeader=null}}}});$(document).on('mouseup',function(e){if(e.target.id=='jexcel_arrow'){if(!$.fn.jexcel.current){$.fn.jexcel.current=$(e.target).parents('.jexcel').parent().prop('id')}
$.fn.jexcel.selectedCell=$(e.target).parent().parent();$('#'+$.fn.jexcel.current).jexcel('updateSelection',$.fn.jexcel.selectedCell,$.fn.jexcel.selectedCell);$('#'+$.fn.jexcel.current).jexcel('openEditor',$.fn.jexcel.selectedCell)}else{if(e.which!=3){$("#jexcel_contextmenu").css('display','none')}
$.fn.jexcel.selectedCorner=!1;if($.fn.jexcel.resizeColumn){if(typeof($.fn.jexcel.defaults[$.fn.jexcel.current].onresize)=='function'){$.fn.jexcel.defaults[$.fn.jexcel.current].onresize($(this),$.fn.jexcel.resizeColumn.column,$.fn.jexcel.resizeColumn.width)}
$('#'+$.fn.jexcel.current).find('thead td').removeClass('resizing');$('#'+$.fn.jexcel.current).find('tbody td').removeClass('resizing');$.fn.jexcel.resizeColumn=null}
var selection=$('#'+$.fn.jexcel.current).find('tbody td.selection');if($(selection).length>0){var o=$(selection[0]).prop('id').split('-');var d=$(selection[selection.length-1]).prop('id').split('-');$('#'+$.fn.jexcel.current).jexcel('copyData',o,d);$(selection).removeClass('selection selection-left selection-right selection-top selection-bottom')}}
if($.fn.jexcel.dragRowFrom){if($.fn.jexcel.dragRowFrom!=$.fn.jexcel.dragRowOver){o=$.fn.jexcel.dragRowFrom.split('-');d=$.fn.jexcel.dragRowOver.split('-');$.fn.jexcel.defaults[$.fn.jexcel.current].data.splice(d[1],0,$.fn.jexcel.defaults[$.fn.jexcel.current].data.splice(o[1],1)[0]);$('#'+$.fn.jexcel.current).jexcel('setData',null,!0);if(typeof($.fn.jexcel.defaults[$.fn.jexcel.current].onmoverow)=='function'){$.fn.jexcel.defaults[$.fn.jexcel.current].onmoverow($(this),$.fn.jexcel.dragRowFrom,$.fn.jexcel.dragRowOver)}}
$('#'+$.fn.jexcel.dragRowFrom).css('cursor','');$('#'+$.fn.jexcel.dragRowOver).css('cursor','');$('#'+$.fn.jexcel.current+' #'+$.fn.jexcel.dragRowOver).parent().find('td').css('background-color','')}
$.fn.jexcel.dragRowFrom=null;$.fn.jexcel.dragRowOver=null});$(document).on('dblclick touchend',function(e){if($.fn.jexcel.current){if($.fn.jexcel.defaults[$.fn.jexcel.current].editable==!0){if(e.target.id=='corner'){var selection=$('#'+$.fn.jexcel.current).find('tbody td.highlight');if(typeof(selection)=='object'){var o=$(selection[0]).prop('id').split('-');var d=$(selection[selection.length-1]).prop('id').split('-');o[1]=parseInt(d[1])+1;d[1]=parseInt($.fn.jexcel.defaults[$.fn.jexcel.current].data.length);$('#'+$.fn.jexcel.current).jexcel('copyData',o,d)}}
if($(e.target).is('.highlight')){$('#'+$.fn.jexcel.current).jexcel('openEditor',$(e.target))}}
if($.fn.jexcel.defaults[$.fn.jexcel.current].columnSorting==!0){if($(e.target).parent().parent().is('thead')){var o=$(e.target).prop('id');if(o){o=$(e.target).prop('id').split('-');$('#'+$.fn.jexcel.current).jexcel('orderBy',o[1])}}}}});$(document).on('mousemove',function(e){if($.fn.jexcel.current){if($.fn.jexcel.defaults[$.fn.jexcel.current].columnResize==!0){if($.fn.jexcel.resizeColumn){var width=e.pageX-$.fn.jexcel.resizeColumn.mousePosition;if($.fn.jexcel.resizeColumn.width+width>0){$('#'+$.fn.jexcel.current).jexcel('setWidth',$.fn.jexcel.resizeColumn.column,$.fn.jexcel.resizeColumn.width+width)}}else{if($(e.target).parent().parent().is('thead')){if($(e.target).outerWidth()-e.offsetX<8&&$(e.target).prop('id')!=''){$(e.target).css('cursor','col-resize')}else{$(e.target).css('cursor','')}}}}
if($.fn.jexcel.defaults[$.fn.jexcel.current].rowDrag==!0){if($(e.target).parent().parent().is('tbody')){if($(e.target).is('.jexcel_label')){if($(e.target).outerWidth()-e.offsetX<8){$(e.target).css('cursor','all-scroll')}else{$(e.target).css('cursor','')}}}}
if(!$($.fn.jexcel.selectedCell).hasClass('edition')){e.preventDefault()}}
if($.fn.jexcel.dragRowFrom){$('body').css('cursor','all-scroll')}else{$('body').css('cursor','')}});$(document).on('mouseover',function(e){if(!$.fn.jexcel.resizeColumn){var table=$(e.target).closest('.jexcel');if($.fn.jexcel.current==$(table).parent().prop('id')){if($(e.target).parent().parent().is('thead')){if($.fn.jexcel.selectedHeader){if(e.buttons){var o=$($.fn.jexcel.selectedHeader).prop('id');var d=$(e.target).prop('id');if(o&&d){o=o.split('-');d=d.split('-');var o1=$('#'+$.fn.jexcel.current).find('#'+o[1]+'-0');var o2=$('#'+$.fn.jexcel.current).find('#'+d[1]+'-'+parseInt($.fn.jexcel.defaults[$.fn.jexcel.current].data.length-1));$('#'+$.fn.jexcel.current).jexcel('updateSelection',o1,o2)}}}}
if($(e.target).parent().parent().is('tbody')){if($(e.target).is('.jexcel_label')){if($.fn.jexcel.selectedRow){if(e.buttons){var o=$($.fn.jexcel.selectedRow).prop('id');var d=$(e.target).prop('id');if(o&&d){o=o.split('-');d=d.split('-');var o1=$('#'+$.fn.jexcel.current).find('#0-'+o[1]);var o2=$('#'+$.fn.jexcel.current).find('#'+parseInt($.fn.jexcel.defaults[$.fn.jexcel.current].columns.length-1)+'-'+d[1]);$('#'+$.fn.jexcel.current).jexcel('updateSelection',o1,o2)}}}else if($.fn.jexcel.dragRowFrom){$('#'+$.fn.jexcel.current+' #'+$.fn.jexcel.dragRowOver).parent().find('td').css('background-color','');$(e.target).parent().find('td').css('background-color','rgba(0,0,0,0.1)');$.fn.jexcel.dragRowOver=$(e.target).prop('id')}}else{if($.fn.jexcel.selectedCell){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if($.fn.jexcel.selectedCorner==!0){$('#'+$.fn.jexcel.current).jexcel('updateCornerSelection',$(e.target))}else{if(e.buttons){$('#'+$.fn.jexcel.current).jexcel('updateSelection',$.fn.jexcel.selectedCell,$(e.target))}}}}}}}}});$(document).on('paste',function(e){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if(e.originalEvent){if($.fn.jexcel.defaults[$.fn.jexcel.current].editable==!0){$('#'+$.fn.jexcel.current).jexcel('paste',$.fn.jexcel.selectedCell,e.originalEvent.clipboardData.getData('text'))}
e.preventDefault()}}});var keyBoardCell=null;$(document).keydown(function(e){if($.fn.jexcel.current){var cell=null;if($.fn.jexcel.selectedCell){columnId=$($.fn.jexcel.selectedCell).prop('id').split('-');if(e.which==37){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if(e.ctrlKey){cell=$($.fn.jexcel.selectedCell).parent().find('td').not('.jexcel_label').first()}else{cell=$($.fn.jexcel.selectedCell).prev()}
e.preventDefault()}}else if(e.which==39){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if(e.ctrlKey){cell=$($.fn.jexcel.selectedCell).parent().find('td').last()}else{cell=$($.fn.jexcel.selectedCell).next()}
e.preventDefault()}}else if(e.which==38){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if(e.ctrlKey){cell=$($.fn.jexcel.selectedCell).parent().parent().find('tr').first().find('#'+columnId[0]+'-'+0)}else{cell=$($.fn.jexcel.selectedCell).parent().prev().find('#'+columnId[0]+'-'+(columnId[1]-1))}
e.preventDefault()}}else if(e.which==40){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if(e.ctrlKey){cell=$($.fn.jexcel.selectedCell).parent().parent().find('tr').last().find('#'+columnId[0]+'-'+($.fn.jexcel.defaults[$.fn.jexcel.current].data.length-1))}else{cell=$($.fn.jexcel.selectedCell).parent().next().find('#'+columnId[0]+'-'+(parseInt(columnId[1])+1))}
e.preventDefault()}}else if(e.which==27){if($($.fn.jexcel.selectedCell).hasClass('edition')){$('#'+$.fn.jexcel.current).jexcel('closeEditor',$($.fn.jexcel.selectedCell),!1)}}else if(e.which==13){if($($.fn.jexcel.selectedCell).hasClass('edition')){if($.fn.jexcel.defaults[$.fn.jexcel.current].columns[columnId[0]].type=='calendar'){$('#'+$.fn.jexcel.current).find('editor').jcalendar('close',1)}else{$('#'+$.fn.jexcel.current).jexcel('closeEditor',$($.fn.jexcel.selectedCell),!0)}}
if($.fn.jexcel.defaults[$.fn.jexcel.current].allowInsertRow==!0){if(columnId[1]==$.fn.jexcel.defaults[$.fn.jexcel.current].data.length-1){$('#'+$.fn.jexcel.current).jexcel('insertRow')}}
cell=$($.fn.jexcel.selectedCell).parent().next().find('#'+columnId[0]+'-'+(parseInt(columnId[1])+1));e.preventDefault()}else if(e.which==9){if($($.fn.jexcel.selectedCell).hasClass('edition')){if($.fn.jexcel.defaults[$.fn.jexcel.current].columns[columnId[0]].type=='calendar'){$('#'+$.fn.jexcel.current).find('editor').jcalendar('close',1)}else{$('#'+$.fn.jexcel.current).jexcel('closeEditor',$($.fn.jexcel.selectedCell),!0)}}
if($.fn.jexcel.defaults[$.fn.jexcel.current].allowInsertColumn==!0){if(columnId[0]==$.fn.jexcel.defaults[$.fn.jexcel.current].data[0].length-1){$('#'+$.fn.jexcel.current).jexcel('insertColumn')}}
if(!$($.fn.jexcel.selectedCell).hasClass('edition')){cell=$($.fn.jexcel.selectedCell).next()}
e.preventDefault()}else if(e.which==46){if($.fn.jexcel.defaults[$.fn.jexcel.current].editable==!0){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){$('#'+$.fn.jexcel.current).jexcel('setValue',$('#'+$.fn.jexcel.current).find('.highlight'),'')}}}else{if(e.metaKey&&!e.shiftKey&&!e.ctrlKey){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if(e.which==67){$('#'+$.fn.jexcel.current).jexcel('copy',!0);e.preventDefault()}}}else if(!e.shiftKey&&!e.ctrlKey){if($.fn.jexcel.selectedCell){if($.fn.jexcel.defaults[$.fn.jexcel.current].editable==!0){if($.fn.jexcel.defaults[$.fn.jexcel.current].columns[columnId[0]].type!='readonly'){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if((e.keyCode>=48&&e.keyCode<=57)||(e.keyCode>=65&&e.keyCode<=90)||(e.keyCode>=96&&e.keyCode<=105)){$('#'+$.fn.jexcel.current).jexcel('openEditor',$($.fn.jexcel.selectedCell),!0)}}}}}}else if(!e.shiftKey&&e.ctrlKey){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){if(e.which==65){t=$(this).find('.jexcel tbody td').not('.jexcel_label');o=$(t).first();t=$(t).last();$('#'+$.fn.jexcel.current).jexcel('updateSelection',o,t);e.preventDefault()}else if(e.which==83){$('#'+$.fn.jexcel.current).jexcel('download');e.preventDefault()}else if(e.which==89){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){$('#'+$.fn.jexcel.current).jexcel('redo')}
e.preventDefault()}else if(e.which==90){if(!$($.fn.jexcel.selectedCell).hasClass('edition')){$('#'+$.fn.jexcel.current).jexcel('undo')}
e.preventDefault()}else if(e.which==67){$('#'+$.fn.jexcel.current).jexcel('copy',!0);e.preventDefault()}else if(e.which==88){if($.fn.jexcel.defaults[$.fn.jexcel.current].editable==!0){$('#'+$.fn.jexcel.current).jexcel('cut')}else{$('#'+$.fn.jexcel.current).jexcel('copy',!0)}
e.preventDefault()}else if(e.which==86){if(window.clipboardData){if($.fn.jexcel.defaults[$.fn.jexcel.current].editable==!0){$('#'+$.fn.jexcel.current).jexcel('paste',$.fn.jexcel.selectedCell,window.clipboardData.getData('Text'))}
e.preventDefault()}}}}}
if(cell){if($(cell).length>0&&$(cell).prop('id').substr(0,3)!='row'){if(e.shiftKey){if(!keyBoardCell){keyBoardCell=$.fn.jexcel.selectedCell}
o=keyBoardCell}else if(e.ctrlKey){keyBoardCell=null;o=cell}else{keyBoardCell=null;o=cell}
t=cell;$.fn.jexcel.selectedCell=cell;$(cell).focus();$('#'+$.fn.jexcel.current).jexcel('updateSelection',o,t)}}}}})}
$(this).jexcel('setData',$.fn.jexcel.defaults[id].data)},setData:function(data,ignoreSpare){var id=$(this).prop('id');if(data){if(typeof(data)=='string'){data=JSON.parse(data)}
$.fn.jexcel.defaults[id].data=data}
$.fn.jexcel.defaults[id].history=[];$.fn.jexcel.defaults[id].historyIndex=-1;var size_i=$.fn.jexcel.defaults[id].colHeaders.length;var size_j=$.fn.jexcel.defaults[id].data.length;var min_i=$.fn.jexcel.defaults[id].minDimensions[0];var min_j=$.fn.jexcel.defaults[id].minDimensions[1];var max_i=min_i>size_i?min_i:size_i;var max_j=min_j>size_j?min_j:size_j;for(j=0;j<max_j;j++){for(i=0;i<max_i;i++){if($.fn.jexcel.defaults[id].data[j]==undefined){$.fn.jexcel.defaults[id].data[j]=[]}
if($.fn.jexcel.defaults[id].data[j][i]==undefined){$.fn.jexcel.defaults[id].data[j][i]=''}}}
$.fn.jexcel.defaults[id].dynamicColumns=[];var tbody=$(this).find('tbody');$(tbody).html('');var records=[];for(j=0;j<$.fn.jexcel.defaults[id].data.length;j++){tr=document.createElement('tr');$(tr).append('<td id="row-'+j+'" class="jexcel_label">'+parseInt(j+1)+'</td>');for(i=0;i<$.fn.jexcel.defaults[id].colHeaders.length;i++){td=$(this).jexcel('createCell',i,j);$(tr).append(td);records.push({cell:$(td),newValue:$.fn.jexcel.defaults[id].data[j][i],oldValue:'',})}
$(tbody).append(tr)}
$(this).jexcel('loadCells',records);if($.fn.jexcel.defaults[id].dynamicColumns.length>0){$(this).jexcel('formula')}
if(!ignoreSpare){$(this).jexcel('spareCheck')}
$(this).jexcel('updateSettings');if(data){if(typeof($.fn.jexcel.defaults[id].onload)=='function'){$.fn.jexcel.defaults[id].onload($(this))}}},updateSettings:function(options){var id=$(this).prop('id');if(!options){if($.fn.jexcel.defaults[id].updateSettingsOptions){options=$.fn.jexcel.defaults[id].updateSettingsOptions}}
if(typeof(options)=='object'){$.fn.jexcel.defaults[id].updateSettingsOptions=options;var cells=$(this).find('.jexcel tbody td').not('.jexcel_label');if(typeof(options.cells)=='function'){$.each(cells,function(k,v){id=$(v).prop('id').split('-');options.cells($(v),id[0],id[1])})}}},openEditor:function(cell,empty){var id=$(this).prop('id');var main=$(this);var options=$.fn.jexcel.defaults[id];var position=$(cell).prop('id').split('-');if($(cell).hasClass('readonly')==!0){}else{$.fn.jexcel.edition=$(cell).html();$.fn.jexcel.editionValue=$(this).jexcel('getValue',$(cell));if(options.columns[position[0]].editor){$(cell).addClass('edition');options.columns[position[0]].editor.openEditor(cell)}else{if(options.columns[position[0]].type=='checkbox'||options.columns[position[0]].type=='hidden'){}else if(options.columns[position[0]].type=='dropdown'){$(cell).addClass('edition');if(typeof(options.columns[position[0]].filter)=='function'){var source=options.columns[position[0]].filter($(this),$(cell),position[0],position[1],options.columns[position[0]].source)}else{var source=options.columns[position[0]].source}
var html='<select>';for(i=0;i<source.length;i++){if(typeof(source[i])=='object'){k=source[i].id;v=source[i].name}else{k=source[i];v=source[i]}
html+='<option value="'+k+'">'+v+'</option>'}
html+='</select>';var value=$(cell).find('input').val();$(cell).html(html);var editor=$(cell).find('select');$(editor).change(function(){$(main).jexcel('closeEditor',$(this).parent(),!0)});$(editor).blur(function(){$(main).jexcel('closeEditor',$(this).parent(),!0)});$(editor).focus();if(value){$(editor).val(value)}}else if(options.columns[position[0]].type=='calendar'){$(cell).addClass('edition');var value=$(cell).find('input').val();var editor=document.createElement('input');$(editor).prop('class','editor');$(editor).css('width',$(cell).width());$(editor).val($(cell).text());$(cell).html(editor);$(cell).find('');$(cell).focus();options.columns[position[0]].options.onclose=function(){$(main).jexcel('closeEditor',$(cell),!0)}
$(editor).jcalendar(options.columns[position[0]].options);$(editor).jcalendar('open',value)}else if(options.columns[position[0]].type=='autocomplete'){showResult=function(data,str){$.each(data,function(k,v){if(typeof(v)=='object'){name=v.name;id=v.id}else{name=v;id=v}
if(name.toLowerCase().indexOf(str.toLowerCase())!=-1){li=document.createElement('li');$(li).prop('id',id)
$(li).html(name);$(li).mousedown(function(e){$(this).parent().removeClass('selected');$(this).addClass('selected');$(main).jexcel('closeEditor',$(cell),!0)});$(result).append(li)}});if(!$(result).html()){$(result).html('<div style="padding:6px;">No result found</div>')}
$(result).css('display','')}
$(cell).addClass('edition');var html=$(cell).text().trim();var value=$(cell).find('input').val();var editor=document.createElement('input');$(editor).prop('class','editor');$(editor).css('width',$(cell).width());if(typeof(options.columns[position[0]].filter)=='function'){var source=options.columns[position[0]].filter($(this),$(cell),position[0],position[1],options.columns[position[0]].source)}else{var source=options.columns[position[0]].source}
var result=document.createElement('div');$(result).prop('class','results');$(result).css('width',$(cell).outerWidth());showResult(source,html.trim());var timeout=null;$(editor).on('keyup',function(e){if(e.which==38){var resultOption=$(result).find('li.selected');if($(resultOption).length){$(resultOption).removeClass('selected');$(resultOption).prev().addClass('selected');$(result).scrollTop($(result).scrollTop()-26)}}else if(e.which==40){var resultOption=$(result).find('li.selected');if($(resultOption).length){$(resultOption).removeClass('selected');$(resultOption).next().addClass('selected');$(result).scrollTop($(result).scrollTop()+26)}else{resultOption=$(result).find('li');$(resultOption[0]).addClass('selected')}}else{var str=$(this).val();if(timeout){clearTimeout(timeout)}
timeout=setTimeout(function(){$(result).html('');if(options.columns[position[0]].url){$.getJSON(options.columns[position[0]].url+'?q='+str+'&r='+$(main).jexcel('getRowData',position[1]),function(data){showResult(data,str)})}else if(source){showResult(source,str)}},500)}});$(cell).html(editor);$(cell).append(result);$(editor).focus();$(editor).val(html);$(editor).blur(function(){$(main).jexcel('closeEditor',$(cell),!1)})}else{$(cell).addClass('edition');if(options.wordWrap==!0||options.columns[position[0]].wordWrap==!0){var input=$(cell).find('textarea')}else{var input=$(cell).find('input')}
if($(input).length){var html=$(input).val()}else{var html=$(cell).html()}
if(options.wordWrap==!0||options.columns[position[0]].wordWrap==!0){var editor=document.createElement('textarea')}else{var editor=document.createElement('input')}
$(editor).prop('class','editor');$(editor).css('width',$(cell).width());$(editor).css('height',$(cell).height());$(cell).html(editor);if(options.columns[position[0]].mask){if(!$.fn.masked){console.error('Jexcel: it was not possible to load the mask plugin.')}else{$(editor).mask(options.columns[position[0]].mask,options.columns[position[0]].options)}}
$(editor).focus();if(!empty){$(editor).val(html)}
$(editor).blur(function(){$(main).jexcel('closeEditor',$(this).parent(),!0)})}}}},closeEditor:function(cell,save){$(cell).removeClass('edition');var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];var position=$(cell).prop('id').split('-');if(save==!0){if(options.columns[position[0]].editor){value=options.columns[position[0]].editor.closeEditor(cell,save)}else{if(options.columns[position[0]].type=='checkbox'||options.columns[position[0]].type=='hidden'){}else if(options.columns[position[0]].type=='dropdown'){var value=$(cell).find('select').val()}else if(options.columns[position[0]].type=='autocomplete'){var obj=$(cell).find('li.selected');if(obj.length>0){var value=$(obj).prop('id')}else{var value=''}}else if(options.columns[position[0]].type=='calendar'){var value=$(cell).find('.jcalendar_value').val()}else{var value=$(cell).find('.editor').val()}}
$.fn.jexcel.defaults[id].data[position[1]][position[0]]=value;$(this).jexcel('updateCells',[{cell:$(cell),newValue:value,oldValue:$.fn.jexcel.editionValue}])}else{if(options.columns[position[0]].type=='calendar'){}else{$(cell).html($.fn.jexcel.edition);$.fn.jexcel.edition=null}}},getCell:function(cell){cell=$(this).jexcel('getIdFromColumnName',cell);cell=$(this).find('[id='+cell+']');return cell},getValue:function(cell){var value=null;if(typeof(cell)!='object'){cell=$(this).jexcel('getIdFromColumnName',cell);cell=$(this).find('[id='+cell+']')}
if($(cell).length){var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];var position=$(cell).prop('id').split('-');if(options.columns[position[0]].editor){value=options.columns[position[0]].editor.getValue(cell)}else{if(options.columns[position[0]].type=='checkbox'){value=$(cell).find('input').is(':checked')?'1':'0'}else if(options.columns[position[0]].type=='dropdown'||options.columns[position[0]].type=='autocomplete'||options.columns[position[0]].type=='calendar'){value=$(cell).find('input').val()}else if(options.columns[position[0]].type=='currency'){value=$(cell).html().replace(/\D/g,'')}else{value=$(cell).find('input');if($(value).length){value=$(value).val()}else{value=$(cell).html()}}}}
return value},setValue:function(cell,value){if(typeof(cell)!=='object'){cell=$(this).jexcel('getIdFromColumnName',cell);cell=$(this).find('[id='+cell+']')}
if($(cell).length){var id=$(this).prop('id');var main=$(this);var options=$.fn.jexcel.defaults[id];var records=[];$.each(cell,function(k,v){records.push({cell:$(v),newValue:value,oldValue:$(main).jexcel('getValue',$(v)),})});$(this).jexcel('updateCells',records);return!0}else{return!1}},loadCells:function(cells){var id=$(this).prop('id');var main=$(this);var options=$.fn.jexcel.defaults[id];$.each(cells,function(k,v){$(main).jexcel('updateCell',v,!0)})},updateCells:function(cells,ignoreHistory){var id=$(this).prop('id');var main=$(this);var options=$.fn.jexcel.defaults[id];$.each(cells,function(k,v){if(typeof(options.onbeforechange)=='function'){options.onbeforechange($(this),$(v.cell),v.oldValue,v.newValue)}
$(main).jexcel('updateCell',v,!1);if(typeof(options.onchange)=='function'){options.onchange($(this),$(v.cell),v.newValue)}});$(this).jexcel('afterChange');if(!ignoreHistory){$(this).jexcel('setHistory',cells)}},updateCell:function(v,force){var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];var position=$(v.cell).prop('id').split('-');value=''+v.newValue;if(options.columns[position[0]].editor){options.columns[position[0]].editor.setValue($(v.cell),value)}else if($(v.cell).hasClass('readonly')==!0&&force==!1){value=null}else{if(options.columns[position[0]].type=='checkbox'){if(value==1||value==!0){$(v.cell).find('input').prop('checked',!0)}else{$(v.cell).find('input').prop('checked',!1)}
v.oldValue=!v.newValue}else if(options.columns[position[0]].type=='dropdown'||options.columns[position[0]].type=='autocomplete'){key='';val='';if(value){var combo=[];var source=options.columns[position[0]].source;for(num=0;num<source.length;num++){if(typeof(source[num])=='object'){combo[source[num].id]=source[num].name}else{combo[source[num]]=source[num]}}
if(combo[value]){key=value;val=combo[value]}else{val=null}}
if(!val){val='&nbsp'}
$(v.cell).html('<input type="hidden" value="'+key+'">'+val+'<span class="jexcel_arrow"><span id="jexcel_arrow"></span></span>')}else if(options.columns[position[0]].type=='calendar'){val='';if(value!='undefined'){val=$.fn.jcalendar('label',value,options.columns[position[0]].options.format)}else{val=''}
$(v.cell).html('<input type="hidden" value="'+value+'">'+val)}else{if(value){if(value.substr(0,1)=='='){if($.fn.jexcel.defaults[id].dynamicColumns.indexOf($(v.cell).prop('id'))==-1){$.fn.jexcel.defaults[id].dynamicColumns.push($(v.cell).prop('id'))}}}
$(v.cell).html(value)}}
$.fn.jexcel.defaults[id].data[position[1]][position[0]]=value},updateSelection:function(o,d,ignoreEvents,origin){var main=$(this);var id=$(this).prop('id');var cells=$(this).find('tbody td');var header=$(this).find('thead td');var previousStatus=($(this).find('.highlight').length>0)?!0:!1;var currentStatus=!1;$(cells).removeClass('highlight');$(cells).removeClass('highlight-left');$(cells).removeClass('highlight-right');$(cells).removeClass('highlight-top');$(cells).removeClass('highlight-bottom');$(header).removeClass('selected');$(cells).removeClass('selected');if(o&&d){$(o).addClass('selected');or=$(o).prop('id').split('-');de=$(d).prop('id').split('-');if(parseInt(or[0])<parseInt(de[0])){px=parseInt(or[0]);ux=parseInt(de[0])}else{px=parseInt(de[0]);ux=parseInt(or[0])}
if(parseInt(or[1])<parseInt(de[1])){py=parseInt(or[1]);uy=parseInt(de[1])}else{py=parseInt(de[1]);uy=parseInt(or[1])}
for(i=px;i<=ux;i++){for(j=py;j<=uy;j++){$(this).find('#'+i+'-'+j).addClass('highlight');$(this).find('#'+px+'-'+j).addClass('highlight-left');$(this).find('#'+ux+'-'+j).addClass('highlight-right');$(this).find('#'+i+'-'+py).addClass('highlight-top');$(this).find('#'+i+'-'+uy).addClass('highlight-bottom');$(main).find('#col-'+i).addClass('selected');$(main).find('#row-'+j).addClass('selected')}}
var currentStatus=!0}
if(!ignoreEvents){if($.fn.jexcel.defaults[id].onblur){if(typeof($.fn.jexcel.defaults[id].onblur)=='function'){if(previousStatus==!0&&currentStatus==!1){$.fn.jexcel.defaults[id].onblur($(this))}}}
if($.fn.jexcel.defaults[id].onfocus){if(typeof($.fn.jexcel.defaults[id].onfocus)=='function'){if(previousStatus==!1&&currentStatus==!0){$.fn.jexcel.defaults[id].onfocus($(this))}}}
if(currentStatus==!0){if(!ignoreEvents){if($.fn.jexcel.defaults[id].onselection){if(typeof($.fn.jexcel.defaults[id].onselection)=='function'){$.fn.jexcel.defaults[id].onselection($(this),o,d,origin)}}}}}
$(this).jexcel('updateCornerPosition')},updateCornerSelection:function(current){var main=$(this);var cells=$(this).find('tbody td');$(cells).removeClass('selection');$(cells).removeClass('selection-left');$(cells).removeClass('selection-right');$(cells).removeClass('selection-top');$(cells).removeClass('selection-bottom');var selection=$(this).find('tbody td.highlight');var s=$(selection[0]).prop('id').split('-');var d=$(selection[selection.length-1]).prop('id').split('-');var c=$(current).prop('id').split('-');if(c[1]>d[1]||c[1]<s[1]){var px=parseInt(s[0]);var ux=parseInt(d[0]);if(parseInt(c[1])>parseInt(d[1])){var py=parseInt(d[1])+1;var uy=parseInt(c[1])}else{var py=parseInt(c[1]);var uy=parseInt(s[1])-1}}else if(c[0]>d[0]||c[0]<s[0]){var py=parseInt(s[1]);var uy=parseInt(d[1]);if(parseInt(c[0])>parseInt(d[0])){var px=parseInt(d[0])+1;var ux=parseInt(c[0])}else{var px=parseInt(c[0]);var ux=parseInt(s[0])-1}}
for(j=py;j<=uy;j++){for(i=px;i<=ux;i++){$(this).find('#'+i+'-'+j).addClass('selection');$(this).find('#'+i+'-'+py).addClass('selection-top');$(this).find('#'+i+'-'+uy).addClass('selection-bottom');$(this).find('#'+px+'-'+j).addClass('selection-left');$(this).find('#'+ux+'-'+j).addClass('selection-right')}}},updateCornerPosition:function(){var cells=$(this).find('.highlight');if($(cells).length){corner=$(cells).last();var t=parseInt($(corner).offset().top)+$(corner).parent().outerHeight()-4;var l=parseInt($(corner).offset().left)+$(corner).outerWidth()-4;$('.jexcel_corner').css('top',t);$('.jexcel_corner').css('left',l)}},getRowData:function(row){row=$(this).find('#row-'+row).parent().find('td').not(':first');var str='';if(row.length>0){for(i=0;i<row.length;i++){str+=$(this).jexcel('getValue',$(row)[i])+','}}
return str},getData:function(highlighted){var dataset=[];var px=0;var py=0;var x=$(this).find('thead tr td').not(':first').length;var y=$(this).find('tbody tr').length;for(j=0;j<y;j++){px=0;for(i=0;i<x;i++){cell=$(this).find('#'+i+'-'+j);if(!highlighted||$(cell).hasClass('highlight')){if(!dataset[py]){dataset[py]=[]}
dataset[py][px]=$(this).jexcel('getValue',$(cell));px++}}
if(px>0){py++}}
return dataset},copy:function(highlighted,delimiter,returnData){if(!delimiter){delimiter="\t"}
var str='';var row='';var val='';var pc=!1;var pr=!1;var x=$(this).find('thead tr td').not(':first').length;var y=$(this).find('tbody tr').length;for(j=0;j<y;j++){row='';pc=!1;for(i=0;i<x;i++){cell=$(this).find('#'+i+'-'+j);if(!highlighted||$(cell).hasClass('highlight')){if(pc){row+=delimiter}
val=$(this).jexcel('getValue',$(cell));if(val.match(/,/g)||val.match(/\n/)){val='"'+val+'"'}
row+=val;pc=!0}}
if(row){if(pr){str+="\n"}
str+=row;pr=!0}}
if(!returnData){txt=$('.jexcel_textarea');$(txt).val(str);$(txt).select();document.execCommand("copy")}
return str},cut:function(){var main=$(this);$(this).jexcel('copy',!0);var cells=$(this).find('.highlight');$(this).jexcel('setValue',cells,'')},paste:function(cell,data){var id=$(this).prop('id');data=$(this).jexcel('parseCSV',data,"\t")
var position=$(cell).prop('id');if(position){position=position.split('-');var x=parseInt(position[0]);var y=parseInt(position[1]);if(y+data.length>$.fn.jexcel.defaults[id].data.length){$(this).jexcel('insertRow',y+data.length-$.fn.jexcel.defaults[id].data.length)}
if(data[0]){row=data[0];if(x+row.length>$.fn.jexcel.defaults[id].data[y].length){$(this).jexcel('insertColumn',x+row.length-$.fn.jexcel.defaults[id].data[y].length)}}
var records=[];for(j=0;j<data.length;j++){row=data[j];for(i=0;i<row.length;i++){cell=$(this).find('#'+(parseInt(i)+parseInt(x))+'-'+(parseInt(j)+parseInt(y)));if($(cell).length>0){records.push({cell:$(cell),newValue:row[i],oldValue:$(this).jexcel('getValue',$(cell)),})}}}
if(records.length>0){$(this).jexcel('updateCells',records)}}},parseCSV:function(CSV_string,delimiter){delimiter=(delimiter||",");var pattern=new RegExp(("(\\"+delimiter+"|\\r?\\n|\\r|^)"+"(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|"+"([^\"\\"+delimiter+"\\r\\n]*))"),"gi");var rows=[[]];var matches=!1;while(matches=pattern.exec(CSV_string)){var matched_delimiter=matches[1];if(matched_delimiter.length&&matched_delimiter!==delimiter){rows.push([])}
var matched_value;if(matches[2]){matched_value=matches[2].replace(new RegExp("\"\"","g"),"\"")}else{matched_value=matches[3]}
rows[rows.length-1].push(matched_value)}
return rows},insertColumn:function(numColumns,properties,position,ignoreEvents){var main=$(this);var id=$(this).prop('id');if(!numColumns){numColumns=1}
var defaults={column:{type:'text'},width:'50',align:'center'};properties=$.extend(defaults,properties);var options=$.fn.jexcel.defaults[id];var records=[];if(options.allowInsertColumn==!0){var num=options.colHeaders.length;for(i=num;i<(num+numColumns);i++){options.colHeaders[i]=properties.header||$.fn.jexcel('getColumnName',i);options.colWidths[i]=properties.width;options.colAlignments[i]=properties.align;options.columns[i]=properties.column;if(!options.columns[i].source){$.fn.jexcel.defaults[id].columns[i].source=[]}
if(!options.columns[i].options){$.fn.jexcel.defaults[id].columns[i].options=[]}
width=options.colWidths[i];align=options.colAlignments[i];header=options.colHeaders[i];var td='<td id="col-'+i+'" width="'+width+'" align="'+align+'">'+header+'</td>';var tr=$(this).find('thead.jexcel_label tr')[0];$(tr).append(td);tr=$(this).find('table > tbody > tr');$.each(tr,function(k,v){options.data[k][i]='';td=$(main).jexcel('createCell',i,k);$(v).append(td);records.push({cell:$(td),newValue:'',oldValue:'',})})}
$(this).jexcel('loadCells',records,!0);if(!ignoreEvents){if(typeof(options.oninsertcolumn)=='function'){options.oninsertcolumn($(this))}}
$(this).jexcel('afterChange')}},insertRow:function(numLines,position,ignoreEvents){var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];var records=[];if(options.allowInsertRow==!0){if(!numLines){numLines=1}
j=parseInt($.fn.jexcel.defaults[id].data.length);for(row=0;row<numLines;row++){tr=document.createElement('tr');$(tr).append('<td id="row-'+j+'" class="jexcel_label">'+parseInt(j+1)+'</td>');$.fn.jexcel.defaults[id].data[j]=[];for(i=0;i<$.fn.jexcel.defaults[id].colHeaders.length;i++){$.fn.jexcel.defaults[id].data[j][i]='';td=$(this).jexcel('createCell',i,j);$(tr).append(td);records.push({cell:$(td),newValue:'',oldValue:'',})}
$(this).find('tbody').append(tr);j++}
$(this).jexcel('loadCells',records,!0);if(!ignoreEvents){if(typeof(options.oninsertrow)=='function'){options.oninsertrow($(this))}}
$(this).jexcel('afterChange')}},deleteRow:function(lineNumber){var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];if(options.allowDeleteRow==!0){if(options.data.length>1){if(parseInt(lineNumber)>-1){$.fn.jexcel.defaults[id].data.splice(parseInt(lineNumber),1);$(this).jexcel('setData')}
if(typeof(options.ondeleterow)=='function'){options.ondeleterow($(this))}
$(this).jexcel('afterChange')}else{console.error('It is not possible to delete the last row')}}},deleteColumn:function(columnNumber){var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];if(options.allowDeleteColumn==!0){if(options.data[0].length>1){if(parseInt(columnNumber)>-1){options.columns.splice(parseInt(columnNumber),1);options.colHeaders.splice(parseInt(columnNumber),1);options.colAlignments.splice(parseInt(columnNumber),1);options.colWidths.splice(parseInt(columnNumber),1);for(j=0;j<$.fn.jexcel.defaults[id].data.length;j++){options.data[j].splice(parseInt(columnNumber),1)}
$(this).find('.c'+parseInt(columnNumber)).remove();$(this).find('#col-'+parseInt(columnNumber)).remove();$(this).jexcel('resetHeaders');$(this).jexcel('setData')}
if(typeof(options.ondeletecolumn)=='function'){options.ondeletecolumn($(this))}
$(this).jexcel('afterChange')}else{console.error('It is not possible to delete the last column')}}},setWidth:function(column,width){if(width>0){if(typeof(column)=='object'){column=$(column).prop('id').split('-');column=column[0]}
var col=$(this).find('thead #col-'+column);if(col.length){$(col).prop('width',width)}}},getWidth:function(column){if(typeof(column)=='object'){column=$(column).prop('id').split('-');column=column[0]}
var col=$(this).find('thead #col-'+column);if(col.length){return $(col).prop('width')}},getHeader:function(column){var col=$(this).find('thead #col-'+column);if(col.length){return $(col).html()}},setHeader:function(column,title){if(title){var col=$(this).find('thead #col-'+column);if(col.length){$(col).html(title)}}},resetHeaders:function(){var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];var tr='<td width="30" class="jexcel_label"></td>';for(i=0;i<options.colHeaders.length;i++){width=options.colWidths[i];align=options.colAlignments[i];header=options.colHeaders[i];if(options.columns[i].type=='hidden'){tr+='<td id="col-'+i+'" style="display:none;">'+options.colHeaders[i]+'</td>'}else{tr+='<td id="col-'+i+'" width="'+width+'" align="'+align+'">'+header+'</td>'}}
$(this).find('thead.jexcel_label').html('<tr>'+tr+'</tr>')},setSource:function(column,source){if(typeof(column)=='object'){column=$(column).prop('id').split('-');column=column[0]}
var id=$(this).prop('id');$.fn.jexcel.defaults[id].columns[column].source=source},afterChange:function(ignoreSpare){var id=$(this).prop('id');if($.fn.jexcel.defaults[id].dynamicColumns.length>0){$(this).jexcel('formula')}
if(typeof($.fn.jexcel.defaults[id].onafterchange)=='function'){$.fn.jexcel.defaults[id].onafterchange($(this))}
if(!ignoreSpare){$(this).jexcel('spareCheck')}
$(this).jexcel('updateCornerPosition');$(this).jexcel('updateSettings')},copyData:function(o,d){var data=$(this).jexcel('getData',!0);var px=parseInt(o[0]);var ux=parseInt(d[0]);var py=parseInt(o[1]);var uy=parseInt(d[1]);var records=[];var posx=0;var posy=0;for(j=py;j<=uy;j++){if(data[posy]==undefined){posy=0}
posx=0;for(i=px;i<=ux;i++){if(data[posy]==undefined){posx=0}else if(data[posy][posx]==undefined){posx=0}
cell=$(this).find('#'+i+'-'+j);if($(cell).length&&!$(cell).hasClass('readonly')){records.push({cell:$(cell),newValue:data[posy][posx],oldValue:$(this).jexcel('getValue',$(cell)),})}
posx++}
posy++}
if(records.length>0){$(this).jexcel('updateCells',records)}},orderBy:function(column,order){if(column>=0){var c=$(this).find('#col-'+column).parent();if(!(order=='0'||order=='1')){var d=$(c).find('.arrow-down');if($(d).length>0){order=1}else{order=0}}
$(c).find('.arrow-down').remove();$(c).find('.arrow-up').remove();$(c).find('td').css('text-decoration','none');if(order==1){$(c).find('#col-'+column).append('<span class="arrow-up"></span>').css('text-decoration','underline')}else{$(c).find('#col-'+column).append('<span class="arrow-down"></span>').css('text-decoration','underline')}
$('.jexcel_corner').css('top','-200px');$('.jexcel_corner').css('left','-200px');var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];Array.prototype.sortBy=function(p,o){return this.slice(0).sort(function(a,b){if(!o){return(a[p]>b[p])?1:(a[p]<b[p])?-1:0}else{return(a[p]>b[p])?-1:(a[p]<b[p])?1:0}})}
options.data=options.data.sortBy(column,order);$(this).jexcel('setData',null,!0);if(typeof($.fn.jexcel.defaults[id].onsort)=='function'){$.fn.jexcel.defaults[id].onsort($(this),column,order)}
return!0}},formula:function(){var main=$(this);var id=$(this).prop('id');if($.fn.jexcel.defaults[id].formulas){var formulas=$.fn.jexcel.defaults[id].formulas;$.fn.jexcel.defaults[id].formulas.instance=this}
var columns=$.fn.jexcel.defaults[id].dynamicColumns;var variables=$(this).find('.jexcel tbody td').not('.jexcel_label');$.each(variables,function(k,v){i=$(main).jexcel('getColumnNameFromId',$(v).prop('id'));v=$(main).jexcel('getValue',$(v));if(v==parseInt(v)){window[i]=parseInt(v)}else{window[i]=v}})
if(typeof excelFormulaUtilities=='object'){$.each(columns,function(k,column){formula=$(main).jexcel('getValue',column);if(formula){if(formula.substr(0,1)=='='){value=excelFormulaUtilities.formula2JavaScript(formula);value=eval(value);if(value===null||isNaN(value)){$(main).find('#'+column).addClass('error');value='<input type="hidden" value="'+formula+'">#ERROR';$(main).find('#'+column).html(value)}else{$(main).find('#'+column).removeClass('error');value='<input type="hidden" value="'+formula+'">'+value;$(main).find('#'+column).html(value)}}else{$(main).find('#'+column).removeClass('error');columns.splice(k,1)}}else{$(main).find('#'+column).removeClass('error');columns.splice(k,1)}})}else{console.error('excelFormulaUtilities lib not included')}},helper:function(options){var data=[];if(typeof(options)=='object'){if(options.action=='createEmptyData'){var x=options.cols||10;var y=options.rows||100;for(j=0;j<y;j++){data[j]=[];for(i=0;i<x;i++){data[j][i]=''}}}}
return data},download:function(){var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];var data='';if(options.csvHeaders==!0){data=options.colHeaders.join()+"\n"}
data+=$(this).jexcel('copy',!1,',',!0);var pom=document.createElement('a');var blob=new Blob([data],{type:'text/csv;charset=utf-8;'});var url=URL.createObjectURL(blob);pom.href=url;pom.setAttribute('download','jexcelTable.csv');pom.click()},setHistory:function(changes){var main=$(this);var id=$(this).prop('id');var index=++$.fn.jexcel.defaults[id].historyIndex;var history=($.fn.jexcel.defaults[id].history=$.fn.jexcel.defaults[id].history.slice(0,index+1));history[index]={firstSelected:changes[0].cell,lastSelected:changes[changes.length-1].cell,cellChanges:changes}},undo:function(){var id=$(this).prop('id');var records=[];if($.fn.jexcel.defaults[id].historyIndex>=0){var historyRecord=$.fn.jexcel.defaults[id].history[$.fn.jexcel.defaults[id].historyIndex--];for(var i=0;i<historyRecord.cellChanges.length;i++){records.push({cell:$(historyRecord.cellChanges[i].cell),newValue:historyRecord.cellChanges[i].oldValue,oldValue:historyRecord.cellChanges[i].newValue,})}
$(this).jexcel('updateCells',records,!0);$(this).jexcel('updateSelection',historyRecord.firstSelected,historyRecord.lastSelected)}},redo:function(){var id=$(this).prop('id');if($.fn.jexcel.defaults[id].historyIndex<$.fn.jexcel.defaults[id].history.length-1){var historyRecord=$.fn.jexcel.defaults[id].history[++$.fn.jexcel.defaults[id].historyIndex];$(this).jexcel('updateCells',historyRecord.cellChanges,!0);$(this).jexcel('updateSelection',historyRecord.firstSelected,historyRecord.lastSelected)}},createCell:function(i,j){var id=$(this).prop('id');var options=$.fn.jexcel.defaults[id];align=options.colAlignments[i];width=options.colWidths[i];td=document.createElement('td');$(td).prop('width',width);$(td).prop('align',align);$(td).prop('id',i+'-'+j);$(td).addClass('c'+i);$(td).addClass('r'+j);if(options.columns[i].type=='hidden'){$(td).css('display','none')}else if(options.columns[i].type=='checkbox'){if(options.columns[i].readOnly==!0){$(td).html('<input type="checkbox" disabled="disabled">')}else{$(td).html('<input type="checkbox" onclick="var instance = $(this).parents(\'.jexcel\').parent(); $(instance).jexcel(\'setValue\', $(this).parent(), $(this).prop(\'checked\') ? 1 : 0);">')}}
if(options.columns[i].readOnly==!0){$(td).addClass('readonly','readonly')}
if(options.wordWrap==!0||options.columns[i].wordWrap==!0){$(td).css('white-space','pre')}
return $(td)},spareCheck:function(){var id=$(this).prop('id');var test=!1;if($.fn.jexcel.defaults[id].minSpareCols>0){lastCol=($.fn.jexcel.defaults[id].data[0])?$.fn.jexcel.defaults[id].data[0].length:0;lastRow=$.fn.jexcel.defaults[id].data.length;checkPoint=lastCol-$.fn.jexcel.defaults[id].minSpareCols;if(checkPoint<0){checkPoint=0}
test=!1;for(rowNumber=0;rowNumber<lastRow;rowNumber++){for(colNumber=checkPoint;colNumber<lastCol;colNumber++){if($.fn.jexcel.defaults[id].data[rowNumber][colNumber]){test=!0}}}
if(test){$(this).jexcel('insertColumn',$.fn.jexcel.defaults[id].minSpareCols)}}
if($.fn.jexcel.defaults[id].minSpareRows>0){lastCol=($.fn.jexcel.defaults[id].data[0])?$.fn.jexcel.defaults[id].data[0].length:0;lastRow=$.fn.jexcel.defaults[id].data.length;checkPoint=lastRow-$.fn.jexcel.defaults[id].minSpareRows;if(checkPoint<0){checkPoint=0}
test=!1;for(rowNumber=checkPoint;rowNumber<lastRow;rowNumber++){for(colNumber=0;colNumber<lastCol;colNumber++){if($.fn.jexcel.defaults[id].data[rowNumber][colNumber]){test=!0}}}
if(test){$(this).jexcel('insertRow',$.fn.jexcel.defaults[id].minSpareCols)}}},getColumnName:function(i){var letter='';if(i>701){letter+=String.fromCharCode(64+parseInt(i/676));letter+=String.fromCharCode(64+parseInt((i%676)/26))}else if(i>25){letter+=String.fromCharCode(64+parseInt(i/26))}
letter+=String.fromCharCode(65+(i%26));return letter},getIdFromColumnName:function(id){var t=/^[a-zA-Z]+/.exec(id);if(t){var code=0;for(var i=0;i<t[0].length;i++){code+=parseInt(t[0].charCodeAt(i)-65)}
id=code+'-'+(parseInt(/[0-9]+$/.exec(id))-1)}
return id},getColumnNameFromId:function(cellId){var name=cellId.split('-');return $.fn.jexcel('getColumnName',name[0])+(parseInt(name[1])+1)}};$.fn.jexcel=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments)}else{$.error('Method '+method+' does not exist on jQuery.tooltip')}}})(jQuery);var classyEditor={closeEditor:function(cell,save){$(classyEditor.cell).html(classyEditor.txt.find('textarea').val());classyEditor.txt.remove();$(classyEditor.cell).removeClass('edition')},openEditor:function(cell){var main=this;var html=$(cell).html();var textArea=$('<div style="background:white"><textarea cols="5"/><button style="width:100%">OK</button></div>').appendTo('body');var t=parseInt($(cell).offset().top)+parseInt($(cell).height())+15;var l=parseInt($(cell).offset().left);var width=parseInt($(cell).width());classyEditor.txt=$(textArea);classyEditor.cell=cell;$(textArea).css('position','absolute');$(textArea).css('top',t);$(textArea).css('left',l);$(textArea).css('width',width);$(textArea).find('textarea').val(html);$(textArea).find('textarea').ClassyEdit();$(textArea).find("button").click(classyEditor.closeEditor)},getValue:function(cell){return $(cell).html()},setValue:function(cell,value){$(cell).html(value);return!0}}